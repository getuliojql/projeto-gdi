-------------------
-- CRIAÇÃO DO BD --
-------------------

-- 1. TABELAS INDEPENDENTES --

CREATE TABLE CLIENTE (
    ID_CLIENTE NUMBER(4),
    ENDERECO_RUA VARCHAR(100),
    ENDERECO_CEP VARCHAR(10),
    ENDERECO_COMPLEMENTO VARCHAR(50),
    CONSTRAINT PK_CLIENTE PRIMARY KEY (ID_CLIENTE)
);

CREATE TABLE DESCONTO (
    COD_DESC NUMBER(4),
    VALOR NUMBER(10,2) NOT NULL,
    CONSTRAINT PK_DESCONTO PRIMARY KEY (COD_DESC)
);

CREATE TABLE FUNCIONARIO (
    CPF_FUNC VARCHAR(11),
    NOME VARCHAR(80) NOT NULL,
    CPF_SUPERVISOR VARCHAR(11),
    CONSTRAINT PK_FUNCIONARIO PRIMARY KEY (CPF_FUNC),
    CONSTRAINT FK_FUNC_SUPERVISOR FOREIGN KEY (CPF_SUPERVISOR) REFERENCES FUNCIONARIO(CPF_FUNC)
);

CREATE TABLE PRODUTO (
    ID_PROD NUMBER(4),
    NOME VARCHAR(80) NOT NULL,
    PRECO NUMBER(10,2) NOT NULL,
    CONSTRAINT PK_PRODUTO PRIMARY KEY (ID_PROD)
);

CREATE TABLE FORNECEDOR (
    ID_FORN NUMBER(4),
    NOME VARCHAR(80) NOT NULL,
    CNPJ VARCHAR(14) NOT NULL,
    CONSTRAINT PK_FORNECEDOR PRIMARY KEY (ID_FORN)
);

-- Tabela PEDIDO (Cabeçalho)
CREATE TABLE PEDIDO (
    ID_PEDIDO NUMBER(4),
    DATA_PEDIDO DATE,
    VALOR_TOTAL NUMBER(10,2),
    CONSTRAINT PK_PEDIDO PRIMARY KEY (ID_PEDIDO)
);

-- 2. TABELAS DEPENDENTES / ESPECIALIZAÇÕES --

CREATE TABLE EMAIL (
    ID_CLIENTE NUMBER(4),
    EMAIL VARCHAR(80),
    CONSTRAINT PK_EMAIL PRIMARY KEY (ID_CLIENTE, EMAIL),
    CONSTRAINT FK_EMAIL_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE) ON DELETE CASCADE
);

CREATE TABLE CARTAO (
    COD VARCHAR(20),
    ID_CLIENTE NUMBER(4) NOT NULL,
    CONSTRAINT PK_CARTAO PRIMARY KEY (COD),
    CONSTRAINT FK_CARTAO_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE) ON DELETE CASCADE
);

CREATE TABLE PF (
    ID_CLIENTE NUMBER(4),
    NOME VARCHAR(80) NOT NULL,
    DATA_NASCIMENTO DATE,
    CPF VARCHAR(11),
    CONSTRAINT PK_PF PRIMARY KEY (ID_CLIENTE),
    CONSTRAINT UK_PF_CPF UNIQUE (CPF),
    CONSTRAINT FK_PF_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE)
);

CREATE TABLE PJ (
    ID_CLIENTE NUMBER(4),
    NOME VARCHAR(80) NOT NULL,
    CNPJ VARCHAR(14),
    CONSTRAINT PK_PJ PRIMARY KEY (ID_CLIENTE),
    CONSTRAINT UK_PJ_CNPJ UNIQUE (CNPJ),
    CONSTRAINT FK_PJ_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE)
);

-- Relacionamento FORNECE (M:N)
CREATE TABLE FORNECE (
    ID_PROD NUMBER(4),
    ID_FORN NUMBER(4),
    CONSTRAINT PK_FORNECE PRIMARY KEY (ID_PROD, ID_FORN),
    CONSTRAINT FK_FORNECE_PROD FOREIGN KEY (ID_PROD) REFERENCES PRODUTO(ID_PROD),
    CONSTRAINT FK_FORNECE_FORN FOREIGN KEY (ID_FORN) REFERENCES FORNECEDOR(ID_FORN)
);

--- RELACIONAMENTO TERNÁRIO: FAZPEDIDO
--  PK composta pelas 3 chaves estrangeiras participantes
CREATE TABLE FAZPEDIDO (
    ID_PEDIDO NUMBER(4),
    ID_CLIENTE NUMBER(4) NOT NULL,
    CPF_FUNC VARCHAR(11) NOT NULL,
    COD_DESC NUMBER(4),
    CONSTRAINT PK_FAZPEDIDO PRIMARY KEY (ID_CLIENTE, CPF_FUNC, ID_PEDIDO),
    CONSTRAINT FK_FAZ_PEDIDO FOREIGN KEY (ID_PEDIDO) REFERENCES PEDIDO(ID_PEDIDO),
    CONSTRAINT FK_FAZ_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE),
    CONSTRAINT FK_FAZ_FUNC FOREIGN KEY (CPF_FUNC) REFERENCES FUNCIONARIO(CPF_FUNC),
    CONSTRAINT FK_FAZ_DESC FOREIGN KEY (COD_DESC) REFERENCES DESCONTO(COD_DESC)
);

-- Entidade Fraca ITEM_PEDIDO (Depende de Pedido e Produto)
CREATE TABLE ITEM_PEDIDO (
    ID_PEDIDO NUMBER(4),
    NRO_ITEM NUMBER(4),
    QUANTIDADE NUMBER(4),
    VALOR_UNITARIO NUMBER(10,2),
    ID_PROD NUMBER(4) NOT NULL,
    CONSTRAINT PK_ITEM_PEDIDO PRIMARY KEY (ID_PEDIDO, NRO_ITEM),
    CONSTRAINT FK_ITEM_PEDIDO FOREIGN KEY (ID_PEDIDO) REFERENCES PEDIDO(ID_PEDIDO),
    CONSTRAINT FK_ITEM_PRODUTO FOREIGN KEY (ID_PROD) REFERENCES PRODUTO(ID_PROD)
);


----------------------
-- POVOAMENTO DO BD --
----------------------

-- 1. Inserindo CLIENTES
INSERT INTO CLIENTE VALUES (1, 'RUA DA AURORA', '50050-000', 'APTO 101');
INSERT INTO CLIENTE VALUES (2, 'AVENIDA BOA VIAGEM', '51020-000', 'LOJA A');
INSERT INTO CLIENTE VALUES (3, 'RUA DO PRINCIPE', '50010-000', NULL);
INSERT INTO CLIENTE VALUES (4, 'RUA NOVA', '50020-000', 'SALA 3');

-- 2. Inserindo PF e PJ (Especialização)
INSERT INTO PF VALUES (1, 'JOAO SILVA', TO_DATE('15/05/1985', 'DD/MM/YYYY'), '11122233344');
INSERT INTO PF VALUES (3, 'MARIA SOUZA', TO_DATE('20/10/1990', 'DD/MM/YYYY'), '55566677788');

INSERT INTO PJ VALUES (2, 'TECH SOLUTIONS LTDA', '12345678000199');
INSERT INTO PJ VALUES (4, 'COMERCIO VARIEDADES', '98765432000188');

-- 3. Inserindo EMAIL e CARTAO
INSERT INTO EMAIL VALUES (1, 'joao@gmail.com');
INSERT INTO EMAIL VALUES (1, 'joao.silva@hotmail.com');
INSERT INTO EMAIL VALUES (2, 'contato@techsolutions.com');

INSERT INTO CARTAO VALUES ('1234-5678-9012-3456', 1);
INSERT INTO CARTAO VALUES ('9876-5432-1098-7654', 2);

-- 4. Inserindo FUNCIONARIOS
INSERT INTO FUNCIONARIO VALUES ('99988877700', 'CARLOS GERENTE', NULL);
INSERT INTO FUNCIONARIO VALUES ('11122233300', 'ANA VENDEDORA', '99988877700');
INSERT INTO FUNCIONARIO VALUES ('44455566600', 'PEDRO ATENDENTE', '99988877700');

-- 5. Inserindo FORNECEDORES e PRODUTOS
INSERT INTO FORNECEDOR VALUES (10, 'DELL COMPUTADORES', '55544433300011');
INSERT INTO FORNECEDOR VALUES (20, 'PAPELARIA CENTRAL', '99988877700022');

INSERT INTO PRODUTO VALUES (100, 'NOTEBOOK DELL', 4500.00);
INSERT INTO PRODUTO VALUES (101, 'MOUSE OPTICO', 50.00);
INSERT INTO PRODUTO VALUES (102, 'TECLADO MECANICO', 250.00);
INSERT INTO PRODUTO VALUES (103, 'MONITOR 24 POL', 1200.00);

-- Relacionamento FORNECE
INSERT INTO FORNECE VALUES (100, 10);
INSERT INTO FORNECE VALUES (101, 10);
INSERT INTO FORNECE VALUES (102, 20);
INSERT INTO FORNECE VALUES (103, 10);

-- 6. Inserindo DESCONTOS
INSERT INTO DESCONTO VALUES (1, 0.00);   -- Sem desconto
INSERT INTO DESCONTO VALUES (2, 100.00); -- R$ 100 off
INSERT INTO DESCONTO VALUES (3, 50.00);  -- R$ 50 off

-- 7. Inserindo PEDIDOS e RELACIONAMENTOS

-- Pedido 5001: Cliente 1 (Joao), Funcionario Ana, Desconto 1 (0.00)
INSERT INTO PEDIDO VALUES (5001, TO_DATE('01/12/2023', 'DD/MM/YYYY'), 4550.00);
INSERT INTO FAZPEDIDO VALUES (5001, 1, '11122233300', 1);

    -- Itens do Pedido 5001 (1 Notebook + 1 Mouse)
    INSERT INTO ITEM_PEDIDO VALUES (5001, 1, 1, 4500.00, 100);
    INSERT INTO ITEM_PEDIDO VALUES (5001, 2, 1, 50.00, 101);

-- Pedido 5002: Cliente 2 (Tech Solutions), Funcionario Carlos, Desconto 2 (100.00)
INSERT INTO PEDIDO VALUES (5002, TO_DATE('02/12/2023', 'DD/MM/YYYY'), 150.00);
INSERT INTO FAZPEDIDO VALUES (5002, 2, '99988877700', 2);

    -- Itens do Pedido 5002 (1 Teclado)
    INSERT INTO ITEM_PEDIDO VALUES (5002, 1, 1, 250.00, 102);

-- Pedido 5003: Cliente 1 (Joao), Funcionario Ana, Desconto 1 (0.00)
INSERT INTO PEDIDO VALUES (5003, TO_DATE('05/12/2023', 'DD/MM/YYYY'), 1200.00);
INSERT INTO FAZPEDIDO VALUES (5003, 1, '11122233300', 1);

    -- Itens do Pedido 5003 (1 Monitor)
    INSERT INTO ITEM_PEDIDO VALUES (5003, 1, 1, 1200.00, 103);

-- Pedidos para testar HAVING COUNT > 3 (Cliente 1 precisa de mais 2 pedidos)
INSERT INTO PEDIDO VALUES (5004, TO_DATE('06/12/2023', 'DD/MM/YYYY'), 50.00);
INSERT INTO FAZPEDIDO VALUES (5004, 1, '11122233300', 1);
INSERT INTO ITEM_PEDIDO VALUES (5004, 1, 1, 50.00, 101);

INSERT INTO PEDIDO VALUES (5005, TO_DATE('07/12/2023', 'DD/MM/YYYY'), 50.00);
INSERT INTO FAZPEDIDO VALUES (5005, 1, '11122233300', 1);
INSERT INTO ITEM_PEDIDO VALUES (5005, 1, 1, 50.00, 101);

-- Pedido para consulta de subquery linha (Pedido 7 e Item 2 de ref)
INSERT INTO PEDIDO VALUES (7, TO_DATE('10/12/2023', 'DD/MM/YYYY'), 300.00);
INSERT INTO FAZPEDIDO VALUES (7, 3, '44455566600', 1);

    INSERT INTO ITEM_PEDIDO VALUES (7, 1, 1, 50.00, 101);
    INSERT INTO ITEM_PEDIDO VALUES (7, 2, 5, 50.00, 102); -- Item referência (Prod 102, Qtd 5)

-- Pedido correspondente ao match da subquery
INSERT INTO PEDIDO VALUES (8, TO_DATE('11/12/2023', 'DD/MM/YYYY'), 250.00);
INSERT INTO FAZPEDIDO VALUES (8, 4, '44455566600', 1);
    INSERT INTO ITEM_PEDIDO VALUES (8, 1, 5, 50.00, 102);